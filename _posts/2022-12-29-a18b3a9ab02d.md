---
title: ã€MySQLã€‘Stored Procedure é å­˜ç¨‹åº
author: Martin
date: 2022-12-29T13:56:37.328+0000
last_modified_at: 2023-02-18T06:50:06.365+0000
categories: 
tags: []
description: æ›åˆ°æ–°å…¬å¸ä¹Ÿå°‡æ»¿ä¸‰å€‹æœˆï¼Œä¹Ÿç¸½ç®—æ˜¯å›åˆ°å¾Œç«¯çš„èˆå°åšè‘—ã€Œå¾Œç«¯ã€å·¥ç¨‹å¸«çš„å·¥ä½œäº†ï¼Œé€™æ®µæ™‚é–“èˆ‡è³‡æ–™åº«æœ‰æ›´æ·±çš„äº¤æ‰‹ï¼Œç‚ºäº†å¹«é‡‘é­šè…¦çš„è‡ªå·±ç•™é»ç´€éŒ„ï¼Œå¹´åº•äº†ä¹Ÿè©²é™¤é™¤è‰å¿«æ¯”äººé«˜çš„éƒ¨è½æ ¼orz
å»¢è©±å°‘èªªï¼Œå°±è®“æˆ‘å€‘é€²å…¥æ­£é¡Œå§ï¹”

render_with_liquid: false
---

### ã€MySQLã€‘Stored Procedure é å­˜ç¨‹åº

æ›åˆ°æ–°å…¬å¸ä¹Ÿå°‡æ»¿ä¸‰å€‹æœˆï¼Œä¹Ÿç¸½ç®—æ˜¯å›åˆ°å¾Œç«¯çš„èˆå°åšè‘—ã€Œå¾Œç«¯ã€å·¥ç¨‹å¸«çš„å·¥ä½œäº†ï¼Œé€™æ®µæ™‚é–“èˆ‡è³‡æ–™åº«æœ‰æ›´æ·±çš„äº¤æ‰‹ï¼Œç‚ºäº†å¹«é‡‘é­šè…¦çš„è‡ªå·±ç•™é»ç´€éŒ„ï¼Œå¹´åº•äº†ä¹Ÿè©²é™¤é™¤è‰å¿«æ¯”äººé«˜çš„éƒ¨è½æ ¼orz
å»¢è©±å°‘èªªï¼Œå°±è®“æˆ‘å€‘é€²å…¥æ­£é¡Œå§ï¹”
### \[Stored Procedure\]

å…ˆä¸Šä¸€å¼µåœ–ï¼Œçµ¦é‚„ä¸çŸ¥é“SP\(stored procedure\)çš„äººä¸€é»æ¦‚å¿µ


![sp å¤§æ¦‚æœƒé•·é€™æ¨£](/assets/a18b3a9ab02d/0*wMEva67aPP4Lqu1m)

sp å¤§æ¦‚æœƒé•·é€™æ¨£

SP çš„æ¦‚å¿µå…¶å¯¦å°±æ˜¯ä¸€æ®µé å…ˆå¯«å¥½çš„SQL è…³æœ¬ï¼Œå¯ä»¥ä¸€æ¬¡åŸ·è¡Œå¤šå€‹æŒ‡ä»¤ï¼Œä¸åƒ…å¯ä»¥è·¨è³‡æ–™åº«ã€è³‡æ–™è¡¨ï¼Œé‚„å¯ä»¥åœ¨è£¡é¢åšæµç¨‹æ§åˆ¶ï¼Œè€Œä¸”æŒ‡ä»¤åˆå¯ä»¥é‡æ–°åˆ©ç”¨ã€‚é™¤äº†ä¸Šè¿°é€™äº›ç‰¹æ€§å¤–ï¼ŒSP é‚„æœ‰ä»¥ä¸‹ä¸‰å€‹å„ªé»ï¼š
1. æ¸›å°‘ç¶²è·¯å‚³è¼¸çš„æ™‚é–“
2. å°‡ç›¸é—œçš„å·¥ä½œé›†ä¸­ï¼Œæ–¹ä¾¿ç®¡ç†ã€ä¿®æ”¹
3. SP æœƒè¢«ç·¨è­¯ï¼ˆcompileï¼‰ï¼Œæ•ˆèƒ½æœƒæ›´å¥½ä¸€äº›


ä½ èªªæ˜¯ä¸æ˜¯å¥½æ£’æ£’å‘¢ï¼Ÿ

ç•¶ç„¶ä¹Ÿä¸æ˜¯å…¨ç„¶æ²’æœ‰ç¼ºé»ï¼Œä½œç‚ºä½¿ç”¨2å€‹æœˆçš„ä½¿ç”¨è€…ï¼Œè¦ªèº«é«”æœƒä¸‰å€‹ç¼ºé»ï¼š
1. DEBUGè¶…ç´šå›°é›£\! \! å°‘äº†IDEå¯ä»¥ä¸‹ä¸­æ–·é»ï¼Œå¤©æ›‰å¾—åˆ°åº•æ˜¯åŸ·è¡Œå€’å“ªä¸€è¡Œå™´éŒ¯çš„
2. ä¿®æ”¹æˆæœ¬å¤§ï¼Œå¦‚æœæœ‰æ®µå•†æ¥­é‚è¼¯éœ€è¦æ›´æ”¹ï¼Œæ”¹äº†SP å¾Œï¼Œæ‰€æœ‰å‘¼å«åˆ°æ­¤SP çš„éƒ½è¦åšç›¸å°æ‡‰ä¿®æ”¹
3. ç¨‹å¼ç·¨è­¯æ™‚æª¢æŸ¥ä¸åˆ°ï¼Œä¸åƒä¸€èˆ¬ç¨‹å¼ï¼Œå‡½å¼å°‘äº†åƒæ•¸ã€è®Šæ•¸å‹æ…‹ä¸å°ï¼ŒIDE é¦¬ä¸Šç´…å±å±ï¼Œä½†SP çš„èªæ³•éŒ¯èª¤IDEå¯æ˜¯æª¢æŸ¥ä¸åˆ°çš„å‘¢


é›–ç„¶SP å°±åƒé›™é¢åˆƒï¼Œä½†ç„¡å¯å¦èªæœ‰äº›å ´åˆä»–é‚„æ˜¯å¾ˆé©ç”¨çš„ï¼š
- è·¨è³‡æ–™åº«ã€è·¨å¤šè¡¨çš„æŸ¥è©¢
- æ¯å¤©å›ºå®šåŸ·è¡Œçš„çµ±è¨ˆç³»çµ±ï¼Œå¯æ³›æŒ‡ä¸å¤ªæœƒæ›´å‹•çš„è³‡æ–™åº«æ“ä½œ


æ—¢ç„¶ä»ç®—æœ‰ç”¨ï¼Œå°±è®“æˆ‘ä¾†ç°¡å–®ä»‹ç´¹é€™å€‹å·¥å…·å§\(æ‹‰æ‹‰é›œé›œè¬›äº†ä¸€å †ç¸½ç®—è¦é€²å…¥ä¸»é¡Œäº† ğŸ‘»


![sp å¤§æ¦‚æœƒé•·é€™æ¨£](/assets/a18b3a9ab02d/0*wMEva67aPP4Lqu1m)

sp å¤§æ¦‚æœƒé•·é€™æ¨£

ä¸Šåœ–è®“å¤§å®¶å¤§è‡´æ˜ç™½SP çš„èªæ³•çµæ§‹ï¼Œä»¥ä¸‹åˆ†æ®µèªªæ˜
#### \[DELIMITER\]

ç¬¬ä¸€å€‹ DELIMITER æŠŠSQLé è¨­çš„åˆ†éš”ç¬¦è™Ÿå¾åˆ†è™Ÿ\(ï¼›\)æ”¹æˆå…©å€‹AND\(&&\)ï¼Œé€šå¸¸æœƒåœ¨é–‹å§‹æ’°å¯«SP å‰å…ˆç”¨é€™æŒ‡ä»¤ä¿®æ”¹åˆ†éš”ç¬¦è™Ÿï¼Œå› ç‚ºåœ¨å»ºç«‹SP æ™‚è‹¥æ²’ä¿®æ”¹ï¼ŒåŸ·è¡Œç¨‹å¼çœ‹åˆ°åˆ†è™Ÿå°±æœƒåœæ­¢ï¼ŒSP æ ¹æœ¬å°±ç„¡æ³•å®Œæˆã€‚è‡³æ–¼åˆ†éš”ç¬¦è™Ÿè¦æ”¹æˆæ€æ¨£å°±è¦‹ä»è¦‹æ™º
#### \[å®£å‘Šéšæ®µ\]

æ¥ä¸‹ä¾†å°±æ˜¯å®£å‘ŠSP çš„åå­—å’Œæœƒç”¨åˆ°çš„åƒæ•¸ï¼Œåœ¨SP è£¡æœ‰ä¸‰ç¨®åƒæ•¸ï¹”å‚³å…¥SPçš„åƒæ•¸\(IN\)ã€SPåŸ·è¡Œå®Œè¦å‚³å‡ºçš„åƒæ•¸\(OUT\)ã€å‚³å…¥SP ä½¿ç”¨ä¸”åŸ·è¡Œå®Œè¦å‚³å‡ºçš„åƒæ•¸\(INOUT **\)** ã€‚
```sql
CREATE PROCEDURE get_data(
  IN `startTime` VARCHAR(30),
  IN `endTime` VARCHAR(30),
  OUT `cost` INT,
  INOUT `price` INT
)
```
#### \[åŸ·è¡Œéšæ®µ\]

åœ¨æœ€å‰æ–¹æœƒæœ‰é—œéµå­—BEGINï¼Œç„¶å¾Œé€šå¸¸æœƒå®£å‘Šä¸€äº›åŸ·è¡Œéç¨‹ä¸­æœƒä½¿ç”¨åˆ°çš„è®Šæ•¸
```sql
DECLARE 
  table1 VARCHAR(30),
  sql_string LONGTEXT;
DECLARE whereString VARCHAR(30);
  
SET table1 = 'Drinks.Tea';
SET sql_string = 'SELECT * FROM Discount';
SET whereString = 'WHERE date BETWEEN startTime AND endTime';
```

ä¹‹å¾Œå°±æ˜¯å„ç¨®é‚è¼¯åˆ¤æ–·èˆ‡æµç¨‹æ§åˆ¶
```
-- REPEAT
create procedure sum3(IN var int)

begin
  declare sum int default 0;
  declare i int default 1;
   
  repeat_name:REPEAT -- è¿´åœˆé–‹å§‹
    set sum = sum + i;
    set i = i + 1;
  until i > var end REPEAT repeat_name; -- è¿´åœˆç»“æŸ
   
  select sum; -- å°å‡ºç»“æœ
end
-- LOOP
create procedure sum2(IN var int)

begin
   declare sum int default 0;
   declare i int default 1;
   
  loop_name:LOOP -- è¿´åœˆé–‹å§‹
    if i > var then 
      leave loop_name;  -- åˆ¤æ–·æ¢ä»¶æˆç«‹å°±çµæŸè¿´åœˆ 
    end if;
        
    set sum = sum + i;
    set i = i + 1;
  end LOOP loop_name;  -- è¿´åœˆç»“æŸ
   
  select sum; -- å°å‡ºç»“æœ
end
-- IF 
IF price > 1000 THEN
  SET whereString = CONCAT(whereString, 'AND price > 1000');
END IF;
```

å…¶ä»–æ›´è©³ç´°çš„ä½¿ç”¨èªªæ˜å¯åƒè€ƒé€™ç¯‡


[![]()](https://www.sqlservertutorial.net/sql-server-stored-procedures/)



[![]()](https://medium.com/@stock0139/mysql-%E8%BF%B4%E5%9C%88-while-loop-repeat-b043656b1cd1)



[![]()](https://medium.com/@stock0139/mysql-cursor-ab2dadc79099)

#### \[çµæŸéšæ®µ\]

åŸ·è¡Œéšæ®µçš„æœ€å¾Œæœƒå†åŠ ä¸ŠENDï¼Œæœ€å¾Œå†åŠ ä¸Šä½ æœ€ä¸€é–‹å§‹è¨­å®šçš„åˆ†éš”ç¬¦è™Ÿï¼Œæ­¤æ™‚ä¸€å€‹å®Œæ•´çš„SP æª”æ¡ˆå°±å·®ä¸å¤šå®Œæˆäº†ï¼Œæœ€å¾Œå†è¨˜å¾—æŠŠåˆ†éš”ç¬¦è™Ÿæ”¹å›åŸæœ¬çš„åˆ†è™Ÿå°±å¤§åŠŸå‘Šæˆæ‹‰~

å› æ­¤ä¸€å€‹å®Œæ•´çš„SP å¤§æ¦‚æœƒå¼ä»¥ä¸‹æ¨¡æ¨£
```sql
DELIMITER &&

CREATE DEFINER=`root`@`localhost` PROCEDURE `BuyProduct`(
 IN  in_user_id INT,
 IN  in_product_id INT,
 IN  in_buy_count INT,
 OUT out_result INT
)
BEGIN
    -- å–å¾—ä½¿ç”¨è€…é©—è­‰ç‹€æ…‹
 SET @user_verified := -1;
    
    SELECT verified 
    INTO @user_verified
    FROM `user` 
    WHERE user_id = in_user_id;
    
    IF @user_verified = -1 THEN
  SET out_result = -1; -- ç„¡æ•ˆçš„ä½¿ç”¨è€… ID
 ELSEIF @user_verified = 0 THEN 
  SET out_result = -2; -- ä½¿ç”¨è€…æœªé€šéé©—è­‰
 ELSEIF @user_verified = 1 THEN 
  -- æª¢æŸ¥åº«å­˜æ•¸é‡
        SET @stock := -1;
        
  SELECT stock 
        INTO @stock
        FROM product 
        WHERE product_id = in_product_id;
        
        IF @stock = -1 THEN
   SET out_result = -3; -- ç„¡æ•ˆçš„å•†å“ ID
  ELSEIF @stock < in_buy_count THEN
   SET out_result = -4; -- å•†å“åº«å­˜ä¸è¶³
  ELSE
   -- å»ºç«‹è¨‚å–®
   INSERT INTO `user_order`
   (
    `user_id`,
    `product_id`,
    `order_status`,
    `create_datetime`
            )
   VALUES
   (
    in_user_id,
    in_product_id,
    'NEW ORDER',
    NOW()
            );

   -- å¯«å…¥ LOG
            INSERT INTO `user_log`
   (
    `user_id`,
    `action`,
    `action_datetime`
            )
   VALUES
   (
    in_user_id,
    'CREATE ORDER',
    NOW()
            );
            SET out_result = 1; -- OK
  END IF;
    END IF;
END 
&&
DELIMITER ;
```
#### \[Tips\]

æœ€å¾Œä¾†è¬›ä¸€äº›å„ªåŒ–SP çš„å°æ’‡æ­¥ï¹”
- **SET NOCOUNT ON** 
æ¯ä¸€æ¬¡å°è³‡æ–™åº«çš„æ“ä½œ\(åƒ…é™DQLã€DML\)ï¼Œéƒ½æœƒå›å‚³ä¸€æ¢è¨˜éŒ„è‘—æœ‰å¤šå°‘æ¬„ä½è¢«å½±éŸ¿çš„è¨Šæ¯ï¼Œåœ¨SP åŸ·è¡Œçš„éç¨‹ä¸­ä¹Ÿä¸ä¾‹å¤–åœ°æœƒè¨˜éŒ„è‘—é€™äº›è³‡è¨Šã€‚å› æ­¤åªè¦æ‰‹å‹•é—œæ‰å›å‚³è³‡è¨Šçš„è¨­å®šï¼Œå°±å¯ä»¥æœ‰æ•ˆåœ°æ¸›å°‘ç¶²è·¯å‚³è¼¸çš„æ¶ˆè€—



![](/assets/a18b3a9ab02d/1*LSYlL4GOGNTED_SM48qiWQ.png)

- **Use schema name with object name** 
å¼•ç”¨ä»»ä½•è³‡æ–™è¡¨æ™‚ï¼Œé€£å¸¶è©²è¡¨çš„è³‡æ–™åº«åä¸€èµ·å¯«é€²ç¨‹å¼è£¡ï¼Œå¦‚æ­¤ä¸€ä¾†å¯ä»¥æ›´å¿«é€Ÿåœ°æ‰¾åˆ°è©²è¡¨



![](/assets/a18b3a9ab02d/1*6igLo-EDtmv1WfCzXGLxrQ.png)

- **Use IF EXISTS \(SELECT 1\) instead of \(SELECT \* \)** 
ä½¿ç”¨IF EXISTS èªæ³•æ™‚æœƒæª¢æŸ¥å¾Œæ–¹æ‹¬å¼§å…§æ¢ä»¶æ˜¯å¦æœ‰ä»»ä¸€ç­†ç´€éŒ„ï¼Œæœ‰çš„è©±æ‰æœƒåŸ·è¡ŒTHEN å¾Œæ–¹çš„SQLï¼Œå› æ­¤æ‹¬å¼§å…§çš„æ¢ä»¶è³‡æ–™ä¸€é»éƒ½ä¸é‡è¦ï¼Œåªè¦éç©ºå°±è¡Œï¼Œå› æ­¤æ¯”èµ·SELECT \*ï¼ŒSELECT 1 æ›´æœ‰æ•ˆç‡
- **Try to avoid using SQL Server cursors** 
cursor é›–ç„¶å¯ä»¥å¹«æˆ‘å€‘ç”¨è¿´åœˆçš„æ–¹å¼ä¸€ç­†ç­†æ“ä½œè³‡æ–™ï¼Œä½†å®ƒå…¶å¯¦éå¸¸åƒæ•ˆèƒ½ï¼Œå› æ­¤è¬ä¸å¾—å·²æœ€å¥½åˆ¥ç”¨ï¼Œè¦ç”¨ä¹‹å‰å¯ä»¥å…ˆè€ƒæ…®WHILE æ˜¯å¦ä¹Ÿèƒ½é”åˆ°ä½ è¦çš„æ•ˆæœ


åƒè€ƒé€£çµï¼š


[![]()](https://www.javatpoint.com/mysql-procedure)



[![](https://miro.medium.com/v2/resize:fit:1200/1*fvM64yuTHTAQ0oskN3dCzQ.jpeg)](https://medium.com/@steph.c/5-%E5%80%8B%E4%BD%A0%E4%B8%8D%E8%A9%B2%E4%BD%BF%E7%94%A8-stored-procedure-%E7%9A%84%E5%8E%9F%E5%9B%A0-9ac524fe37ba)



[![](https://ithelp.ithome.com.tw/storage/image/fbpic.jpg)](https://ithelp.ithome.com.tw/articles/10267932)



[![](https://blog.sqlauthority.com/wp-content/uploads/2010/02/spoptimizationtricks.jpg)](https://blog.sqlauthority.com/2010/02/16/sql-server-stored-procedure-optimization-tips-best-practices/)





